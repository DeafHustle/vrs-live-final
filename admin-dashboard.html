<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | americansignlanguage.eth</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #11998e; --primary-light: #38ef7d; --secondary: #667eea;
      --accent: #764ba2; --success: #10b981; --warning: #f59e0b;
      --error: #ef4444; --info: #3b82f6;
      --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
      --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280;
      --gray-600: #4b5563; --gray-700: #374151; --gray-800: #1f2937; --gray-900: #111827;
    }
    body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--gray-100); color: var(--gray-800); min-height: 100vh; }
    .admin-header { background: linear-gradient(135deg, var(--gray-900), var(--gray-800)); color: white; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .admin-title { display: flex; align-items: center; gap: 12px; }
    .admin-title h1 { font-size: 1.25rem; }
    .admin-title span { font-size: 0.75rem; background: var(--primary); padding: 2px 10px; border-radius: 12px; }
    .admin-wallet { font-size: 0.8rem; color: var(--gray-400); font-family: monospace; }
    .admin-btn { padding: 8px 16px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; }
    .admin-btn-primary { background: var(--primary); color: white; }
    .admin-btn-ghost { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
    .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; padding: 24px; max-width: 1400px; margin: 0 auto; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-card-label { font-size: 0.75rem; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card-value { font-size: 2rem; font-weight: 700; margin: 4px 0; color: var(--gray-900); }
    .stat-card-sub { font-size: 0.8rem; color: var(--gray-400); }
    .stat-card.highlight { border-left: 4px solid var(--primary); }
    .stat-card.warning { border-left: 4px solid var(--warning); }
    .stat-card.info { border-left: 4px solid var(--info); }
    .stat-card.accent { border-left: 4px solid var(--accent); }
    .stat-card.success { border-left: 4px solid var(--success); }
    .nav-tabs { display: flex; gap: 4px; padding: 0 24px; max-width: 1400px; margin: 0 auto; overflow-x: auto; }
    .nav-tab { padding: 12px 20px; font-size: 0.9rem; font-weight: 600; color: var(--gray-500); border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.2s; }
    .nav-tab:hover { color: var(--gray-700); }
    .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .nav-tab .badge { display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 700; margin-left: 6px; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .badge-success { background: #d1fae5; color: #065f46; }
    .tab-content { padding: 24px; max-width: 1400px; margin: 0 auto; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .data-table-wrapper { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .table-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--gray-200); flex-wrap: wrap; gap: 12px; }
    .table-header h2 { font-size: 1.1rem; }
    .table-filters { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .filter-select, .search-input { padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 0.85rem; background: white; }
    .search-input { width: 200px; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { text-align: left; padding: 12px 16px; font-size: 0.75rem; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); }
    .data-table td { padding: 14px 16px; font-size: 0.875rem; border-bottom: 1px solid var(--gray-100); vertical-align: middle; }
    .data-table tr:hover td { background: var(--gray-50); }
    .status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-pending .status-dot { background: #f59e0b; }
    .status-approved, .status-active { background: #d1fae5; color: #065f46; }
    .status-approved .status-dot, .status-active .status-dot { background: #10b981; }
    .status-rejected, .status-suspended { background: #fee2e2; color: #991b1b; }
    .status-rejected .status-dot, .status-suspended .status-dot { background: #ef4444; }
    .status-new { background: #dbeafe; color: #1e40af; }
    .status-new .status-dot { background: #3b82f6; }
    .status-contacted { background: #e0e7ff; color: #3730a3; }
    .status-contacted .status-dot { background: #6366f1; }
    .status-converted { background: #d1fae5; color: #065f46; }
    .status-converted .status-dot { background: #10b981; }
    .action-btn { padding: 5px 12px; border: none; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.15s; margin-right: 4px; }
    .action-approve { background: #d1fae5; color: #065f46; }
    .action-approve:hover { background: #a7f3d0; }
    .action-reject { background: #fee2e2; color: #991b1b; }
    .action-reject:hover { background: #fecaca; }
    .action-view { background: #dbeafe; color: #1e40af; }
    .action-view:hover { background: #bfdbfe; }
    .action-suspend { background: #fde8e8; color: #9b1c1c; }
    .action-suspend:hover { background: #fecaca; }
    .action-contact { background: #e0e7ff; color: #3730a3; }
    .action-contact:hover { background: #c7d2fe; }
    .user-name-cell { display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; color: white; flex-shrink: 0; }
    .user-avatar.customer { background: var(--primary); }
    .user-avatar.interpreter { background: var(--secondary); }
    .user-avatar.business { background: var(--accent); }
    .user-avatar.subscriber { background: var(--info); }
    .user-detail { min-width: 0; }
    .user-detail strong { display: block; font-size: 0.875rem; }
    .user-detail small { color: var(--gray-500); font-size: 0.75rem; }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--gray-400); }
    .empty-state-icon { font-size: 3rem; margin-bottom: 12px; }
    .table-footer { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-top: 1px solid var(--gray-200); font-size: 0.8rem; color: var(--gray-500); }
    .pagination { display: flex; gap: 4px; }
    .page-btn { padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; font-size: 0.8rem; cursor: pointer; }
    .page-btn:hover { background: var(--gray-50); }
    .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; padding: 16px; }
    .modal-overlay.open { display: flex; }
    .modal { background: white; border-radius: 16px; max-width: 500px; width: 100%; overflow: hidden; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-400); }
    .modal-body { padding: 24px; }
    .modal-body textarea { width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 0.9rem; font-family: inherit; resize: vertical; min-height: 100px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; gap: 8px; justify-content: flex-end; }
    .loading { text-align: center; padding: 40px; color: var(--gray-400); }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .auth-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--gray-900); }
    .auth-box { background: white; border-radius: 16px; padding: 40px; max-width: 400px; width: 100%; text-align: center; }
    .auth-box h2 { margin: 16px 0 8px; }
    .auth-box p { color: var(--gray-500); font-size: 0.9rem; margin-bottom: 24px; }
    .auth-box .admin-btn { width: 100%; padding: 14px; font-size: 1rem; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .detail-item label { display: block; font-size: 0.7rem; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .detail-item p { margin: 0; font-size: 0.9rem; }
    .detail-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center; margin-top: 20px; }
    .detail-stat { background: var(--gray-50); padding: 12px; border-radius: 8px; }
    .detail-stat-value { font-size: 1.5rem; font-weight: 700; }
    .detail-stat-label { font-size: 0.7rem; color: var(--gray-500); }
    @media (max-width: 768px) {
      .stats-bar { grid-template-columns: 1fr 1fr; }
      .admin-wallet { display: none; }
      .search-input { width: 100%; }
      .detail-grid { grid-template-columns: 1fr; }
      .detail-stats { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="auth-screen" id="authScreen">
    <div class="auth-box">
      <div style="font-size: 3rem;">üîê</div>
      <h2>Admin Access</h2>
      <p>Connect your admin wallet to access the dashboard.</p>
      <button class="admin-btn admin-btn-primary" onclick="connectAdmin()">ü¶ä Connect MetaMask</button>
      <p style="margin-top: 16px; font-size: 0.8rem; color: var(--gray-400);">Only authorized wallets can access admin.</p>
    </div>
  </div>

  <div id="adminApp" style="display: none;">
    <div class="admin-header">
      <div class="admin-title"><h1>ü§ü Admin Dashboard</h1><span>americansignlanguage.eth</span></div>
      <div style="display:flex;align-items:center;gap:12px;">
        <span class="admin-wallet" id="adminWalletDisplay"></span>
        <a href="/" class="admin-btn admin-btn-ghost">‚Üê Back to Site</a>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat-card highlight"><div class="stat-card-label">Total Users</div><div class="stat-card-value" id="statUsers">‚Äî</div><div class="stat-card-sub">Registered customers</div></div>
      <div class="stat-card warning"><div class="stat-card-label">Interpreters</div><div class="stat-card-value" id="statInterpreters">‚Äî</div><div class="stat-card-sub"><span id="statPendingApps">0</span> pending review</div></div>
      <div class="stat-card info"><div class="stat-card-label">Business Inquiries</div><div class="stat-card-value" id="statBusiness">‚Äî</div><div class="stat-card-sub"><span id="statNewBiz">0</span> new</div></div>
      <div class="stat-card accent"><div class="stat-card-label">Subscribers</div><div class="stat-card-value" id="statSubs">‚Äî</div><div class="stat-card-sub">Email list</div></div>
      <div class="stat-card success"><div class="stat-card-label">Total Revenue</div><div class="stat-card-value" id="statRevenue">‚Äî</div><div class="stat-card-sub">All sessions</div></div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('users', this)">üë§ Users <span class="badge badge-info" id="badgeUsers">0</span></button>
      <button class="nav-tab" onclick="switchTab('interpreters', this)">üé§ Interpreters <span class="badge badge-warning" id="badgePending">0</span></button>
      <button class="nav-tab" onclick="switchTab('business', this)">üè¢ Business <span class="badge badge-info" id="badgeBiz">0</span></button>
      <button class="nav-tab" onclick="switchTab('subscribers', this)">üì¨ Subscribers <span class="badge badge-success" id="badgeSubs">0</span></button>
    </div>

    <div class="tab-content">
      <!-- USERS -->
      <div class="tab-panel active" id="panel-users">
        <div class="data-table-wrapper">
          <div class="table-header"><h2>Registered Customers</h2><div class="table-filters"><input type="text" class="search-input" id="userSearch" placeholder="Search name or email..." oninput="debouncedLoadUsers()"></div></div>
          <div id="usersTable"><div class="loading"><div class="spinner"></div>Loading users...</div></div>
        </div>
      </div>

      <!-- INTERPRETERS -->
      <div class="tab-panel" id="panel-interpreters">
        <div class="data-table-wrapper">
          <div class="table-header"><h2>Interpreters</h2><div class="table-filters">
            <select class="filter-select" id="interpFilter" onchange="loadInterpreters()"><option value="">All Status</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option><option value="suspended">Suspended</option></select>
          </div></div>
          <div id="interpTable"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
      </div>

      <!-- BUSINESS -->
      <div class="tab-panel" id="panel-business">
        <div class="data-table-wrapper">
          <div class="table-header"><h2>Business Inquiries</h2><div class="table-filters">
            <select class="filter-select" id="bizFilter" onchange="loadBusiness()"><option value="">All Status</option><option value="new">New</option><option value="contacted">Contacted</option><option value="converted">Converted</option></select>
          </div></div>
          <div id="bizTable"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
      </div>

      <!-- SUBSCRIBERS -->
      <div class="tab-panel" id="panel-subscribers">
        <div class="data-table-wrapper">
          <div class="table-header"><h2>Email Subscribers</h2><div class="table-filters">
            <select class="filter-select" id="subFilter" onchange="loadSubscribers()"><option value="">All Interests</option><option value="user">VRI Services</option><option value="interpreter">Become Interpreter</option><option value="business">Business/Enterprise</option><option value="token">$ASL Token</option><option value="general">General</option></select>
          </div></div>
          <div id="subTable"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reject Modal -->
  <div class="modal-overlay" id="rejectModal">
    <div class="modal">
      <div class="modal-header"><h3>Reject Application</h3><button class="modal-close" onclick="closeModal('rejectModal')">√ó</button></div>
      <div class="modal-body"><p style="margin-bottom:12px;color:var(--gray-600);">Please provide a reason for rejection:</p><textarea id="rejectionReason" placeholder="Enter reason..."></textarea></div>
      <div class="modal-footer"><button class="admin-btn admin-btn-ghost" onclick="closeModal('rejectModal')" style="color:var(--gray-700)">Cancel</button><button class="admin-btn" style="background:var(--error);color:white" onclick="confirmReject()">Reject</button></div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal" style="max-width:560px">
      <div class="modal-header"><h3 id="detailTitle">Details</h3><button class="modal-close" onclick="closeModal('detailModal')">√ó</button></div>
      <div class="modal-body" id="detailBody"></div>
    </div>
  </div>

<script>
let adminWallet = null;
let pendingRejectId = null;
let debounceTimer = null;

// AUTH
async function connectAdmin() {
  if (!window.ethereum) { alert('MetaMask not installed.'); return; }
  try {
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    adminWallet = accounts[0].toLowerCase();
    const res = await fetch('/api/admin/interpreters?limit=1', { headers: { 'X-Admin-Wallet': adminWallet } });
    if (res.status === 403) { alert('Wallet not authorized for admin.'); return; }
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('adminApp').style.display = 'block';
    document.getElementById('adminWalletDisplay').textContent = adminWallet.slice(0,6) + '...' + adminWallet.slice(-4);
    loadAll();
  } catch (e) { alert('Failed: ' + e.message); }
}

function af(url) { return fetch(url, { headers: { 'X-Admin-Wallet': adminWallet } }).then(r => r.json()); }
function ap(url, body) { return fetch(url, { method:'POST', headers:{'Content-Type':'application/json','X-Admin-Wallet':adminWallet}, body:JSON.stringify(body) }).then(r=>r.json()); }

async function loadAll() {
  loadStats(); loadUsers(); loadInterpreters(); loadBusiness(); loadSubscribers();
}

async function loadStats() {
  try {
    const [users, interps, pending, biz, subs] = await Promise.all([
      af('/api/admin/users?limit=1'),
      af('/api/admin/interpreters?limit=1'),
      af('/api/admin/applications/pending'),
      af('/api/admin/contacts?type=business&limit=1'),
      af('/api/admin/contacts?type=subscribe&limit=1')
    ]);
    document.getElementById('statUsers').textContent = users.pagination?.total || 0;
    document.getElementById('badgeUsers').textContent = users.pagination?.total || 0;
    document.getElementById('statInterpreters').textContent = interps.pagination?.total || 0;
    document.getElementById('statPendingApps').textContent = pending.count || 0;
    document.getElementById('badgePending').textContent = pending.count || 0;
    document.getElementById('statBusiness').textContent = biz.pagination?.total || 0;
    document.getElementById('badgeBiz').textContent = biz.pagination?.total || 0;
    const newBiz = await af('/api/admin/contacts?type=business&status=new&limit=1');
    document.getElementById('statNewBiz').textContent = newBiz.pagination?.total || 0;
    document.getElementById('statSubs').textContent = subs.pagination?.total || 0;
    document.getElementById('badgeSubs').textContent = subs.pagination?.total || 0;
    document.getElementById('statRevenue').textContent = '$‚Äî';
  } catch(e) { console.error('Stats error:', e); }
}

function switchTab(tab, el) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-' + tab).classList.add('active');
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function fmtDate(d) { return d ? new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '-'; }
function initials(f,l) { return ((f||'')[0]||'') + ((l||'')[0]||''); }
function debouncedLoadUsers() { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => loadUsers(), 300); }

// ========== USERS ==========
async function loadUsers(page=1) {
  const c = document.getElementById('usersTable');
  c.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
  try {
    const q = document.getElementById('userSearch')?.value || '';
    let url = '/api/admin/users?page='+page+'&limit=20';
    if (q) url += '&search=' + encodeURIComponent(q);
    const data = await af(url);
    const users = data.users || [];
    if (!users.length) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë§</div><h3>No users found</h3></div>'; return; }
    let h = '<table class="data-table"><thead><tr><th>Customer</th><th>VP Phone</th><th>Sessions</th><th>Minutes</th><th>Spent</th><th>$ASL</th><th>Joined</th><th>Actions</th></tr></thead><tbody>';
    users.forEach(u => {
      const s = u.stats||{};
      h += '<tr><td><div class="user-name-cell"><div class="user-avatar customer">'+initials(u.firstName,u.lastName).toUpperCase()+'</div><div class="user-detail"><strong>'+
        (u.firstName||'')+' '+(u.lastName||'')+'</strong><small>'+(u.email||'-')+'</small></div></div></td>'+
        '<td>'+(u.vpPhone||u.phone||'-')+'</td><td>'+(s.totalSessions||0)+'</td><td>'+(s.totalMinutes||0)+'</td>'+
        '<td>$'+((s.totalSpent||0)/100).toFixed(2)+'</td><td>'+(s.tokensEarned||0)+'</td>'+
        '<td>'+fmtDate(u.createdAt)+'</td><td><button class="action-btn action-view" onclick="viewUser(\''+u._id+'\')">View</button></td></tr>';
    });
    h += '</tbody></table>';
    const pg = data.pagination||{};
    if (pg.pages > 1) {
      h += '<div class="table-footer"><span>'+users.length+' of '+pg.total+'</span><div class="pagination">';
      h += '<button class="page-btn" onclick="loadUsers('+(pg.page-1)+')" '+(pg.page<=1?'disabled':'')+'>‚Üê Prev</button>';
      for (let i=1; i<=Math.min(pg.pages,5); i++) h += '<button class="page-btn '+(i===pg.page?'active':'')+'" onclick="loadUsers('+i+')">'+i+'</button>';
      h += '<button class="page-btn" onclick="loadUsers('+(pg.page+1)+')" '+(pg.page>=pg.pages?'disabled':'')+'>Next ‚Üí</button></div></div>';
    }
    c.innerHTML = h;
  } catch(e) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h3>Error loading users</h3><p>'+e.message+'</p></div>'; }
}

async function viewUser(id) {
  try {
    const u = await af('/api/admin/user/'+id);
    const s = u.stats||{};
    document.getElementById('detailTitle').textContent = (u.firstName||'')+' '+(u.lastName||'')+' ‚Äî Customer';
    document.getElementById('detailBody').innerHTML =
      '<div class="detail-grid">'+
        '<div class="detail-item"><label>Email</label><p>'+(u.email||'-')+'</p></div>'+
        '<div class="detail-item"><label>VP Phone</label><p>'+(u.vpPhone||u.phone||'-')+'</p></div>'+
        '<div class="detail-item"><label>Text Phone</label><p>'+(u.textPhone||'-')+'</p></div>'+
        '<div class="detail-item"><label>Joined</label><p>'+fmtDate(u.createdAt)+'</p></div>'+
        '<div class="detail-item"><label>Wallet</label><p style="font-family:monospace;font-size:0.8rem">'+(u.wallet||'Not connected')+'</p></div>'+
        '<div class="detail-item"><label>Stripe ID</label><p style="font-family:monospace;font-size:0.8rem">'+(u.stripeCustomerId||'-')+'</p></div>'+
      '</div>'+
      '<div class="detail-stats">'+
        '<div class="detail-stat"><div class="detail-stat-value">'+(s.totalSessions||0)+'</div><div class="detail-stat-label">Sessions</div></div>'+
        '<div class="detail-stat"><div class="detail-stat-value">'+(s.totalMinutes||0)+'</div><div class="detail-stat-label">Minutes</div></div>'+
        '<div class="detail-stat"><div class="detail-stat-value">$'+((s.totalSpent||0)/100).toFixed(2)+'</div><div class="detail-stat-label">Spent</div></div>'+
        '<div class="detail-stat"><div class="detail-stat-value">'+(s.tokensEarned||0)+'</div><div class="detail-stat-label">$ASL</div></div>'+
      '</div>';
    document.getElementById('detailModal').classList.add('open');
  } catch(e) { alert('Error: '+e.message); }
}

// ========== INTERPRETERS ==========
async function loadInterpreters(page=1) {
  const c = document.getElementById('interpTable');
  c.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
  try {
    const st = document.getElementById('interpFilter')?.value || '';
    let url = '/api/admin/interpreters?page='+page+'&limit=20';
    if (st) url += '&status='+st;
    const data = await af(url);
    const list = data.interpreters || [];
    if (!list.length) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üé§</div><h3>No interpreters found</h3></div>'; return; }
    let h = '<table class="data-table"><thead><tr><th>Interpreter</th><th>Status</th><th>Certifications</th><th>Experience</th><th>Email</th><th>Applied</th><th>Actions</th></tr></thead><tbody>';
    list.forEach(i => {
      const cr = i.credentials||{};
      let certs = [];
      if (cr.ridCertified) certs.push('RID');
      if (cr.nicCertified) certs.push('NIC');
      if (cr.stateLicense) certs.push(cr.stateLicense);
      let acts = '';
      if (i.status==='pending'||i.status==='under_review') {
        acts = '<button class="action-btn action-approve" onclick="approveInterp(\''+i._id+'\')">‚úì</button><button class="action-btn action-reject" onclick="openReject(\''+i._id+'\')">‚úó</button>';
      } else if (i.status==='approved') {
        acts = '<button class="action-btn action-suspend" onclick="suspendInterp(\''+i._id+'\')">‚õî</button>';
      }
      h += '<tr><td><div class="user-name-cell"><div class="user-avatar interpreter">'+initials(i.firstName,i.lastName).toUpperCase()+'</div><div class="user-detail"><strong>'+(i.firstName||'')+' '+(i.lastName||'')+'</strong><small>'+(i.email||'')+'</small></div></div></td>'+
        '<td><span class="status status-'+(i.status||'pending')+'"><span class="status-dot"></span>'+(i.status||'pending')+'</span></td>'+
        '<td>'+(certs.length ? certs.join(', ') : '-')+'</td>'+
        '<td>'+(cr.yearsExperience||0)+'+ yrs</td>'+
        '<td>'+(i.email||'-')+'</td>'+
        '<td>'+fmtDate(i.verification?.submittedAt||i.createdAt)+'</td>'+
        '<td>'+acts+'</td></tr>';
    });
    h += '</tbody></table>';
    c.innerHTML = h;
  } catch(e) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>'+e.message+'</p></div>'; }
}

async function approveInterp(id) {
  if (!confirm('Approve this interpreter?')) return;
  const r = await ap('/api/admin/interpreter/'+id+'/review', { decision:'approved', notes:'Approved via admin' });
  if (r.success) { alert('‚úÖ Approved!'); loadInterpreters(); loadStats(); } else alert('Failed: '+(r.error||'Unknown'));
}

function openReject(id) { pendingRejectId = id; document.getElementById('rejectModal').classList.add('open'); document.getElementById('rejectionReason').value=''; }

async function confirmReject() {
  const reason = document.getElementById('rejectionReason').value.trim();
  if (!reason) { alert('Please provide a reason.'); return; }
  const r = await ap('/api/admin/interpreter/'+pendingRejectId+'/review', { decision:'rejected', rejectionReason:reason });
  if (r.success) { closeModal('rejectModal'); alert('Application rejected.'); loadInterpreters(); loadStats(); } else alert('Failed: '+(r.error||'Unknown'));
}

async function suspendInterp(id) {
  const reason = prompt('Suspension reason:');
  if (!reason) return;
  const r = await ap('/api/admin/interpreter/'+id+'/suspend', { reason });
  if (r.success) { alert('Suspended.'); loadInterpreters(); loadStats(); } else alert('Failed: '+(r.error||'Unknown'));
}

// ========== BUSINESS ==========
async function loadBusiness() {
  const c = document.getElementById('bizTable');
  c.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
  try {
    const st = document.getElementById('bizFilter')?.value || '';
    let url = '/api/admin/contacts?type=business&limit=50';
    if (st) url += '&status='+st;
    const data = await af(url);
    const list = data.contacts || [];
    if (!list.length) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üè¢</div><h3>No business inquiries</h3></div>'; return; }
    let h = '<table class="data-table"><thead><tr><th>Contact</th><th>Company</th><th>Industry</th><th>Est. Volume</th><th>Status</th><th>Submitted</th><th>Actions</th></tr></thead><tbody>';
    list.forEach(b => {
      const name = ((b.firstName||'')+ ' '+(b.lastName||'')).trim() || b.email;
      h += '<tr><td><div class="user-name-cell"><div class="user-avatar business">'+initials(b.firstName,b.lastName).toUpperCase()+'</div><div class="user-detail"><strong>'+name+'</strong><small>'+b.email+'</small></div></div></td>'+
        '<td>'+(b.company||'-')+'</td>'+
        '<td>'+(b.industry||'-')+'</td>'+
        '<td>'+(b.volume||'-')+'</td>'+
        '<td><span class="status status-'+(b.status||'new')+'"><span class="status-dot"></span>'+(b.status||'new')+'</span></td>'+
        '<td>'+fmtDate(b.submittedAt)+'</td>'+
        '<td><button class="action-btn action-view" onclick="viewBiz(\''+b._id+'\')">View</button>'+
        '<button class="action-btn action-contact" onclick="markContacted(\''+b._id+'\')">üìß</button></td></tr>';
    });
    h += '</tbody></table>';
    c.innerHTML = h;
  } catch(e) { c.innerHTML = '<div class="empty-state"><p>'+e.message+'</p></div>'; }
}

function viewBiz(id) {
  af('/api/admin/contacts?type=business&limit=50').then(data => {
    const b = (data.contacts||[]).find(c => c._id === id);
    if (!b) return;
    document.getElementById('detailTitle').textContent = (b.company||'Business') + ' ‚Äî Inquiry';
    document.getElementById('detailBody').innerHTML =
      '<div class="detail-grid">'+
        '<div class="detail-item"><label>Name</label><p>'+(b.firstName||'')+' '+(b.lastName||'')+'</p></div>'+
        '<div class="detail-item"><label>Email</label><p>'+b.email+'</p></div>'+
        '<div class="detail-item"><label>Company</label><p>'+(b.company||'-')+'</p></div>'+
        '<div class="detail-item"><label>Industry</label><p>'+(b.industry||'-')+'</p></div>'+
        '<div class="detail-item"><label>Est. Monthly Volume</label><p>'+(b.volume||'-')+'</p></div>'+
        '<div class="detail-item"><label>Status</label><p><span class="status status-'+(b.status||'new')+'"><span class="status-dot"></span>'+(b.status||'new')+'</span></p></div>'+
      '</div>'+
      (b.message ? '<div style="margin-top:20px"><label style="font-size:0.7rem;font-weight:600;color:var(--gray-500);text-transform:uppercase">Message</label><p style="margin-top:8px;padding:12px;background:var(--gray-50);border-radius:8px">'+b.message+'</p></div>' : '');
    document.getElementById('detailModal').classList.add('open');
  });
}

async function markContacted(id) {
  const r = await ap('/api/admin/contact/'+id+'/status', { status: 'contacted' });
  if (r.success) { loadBusiness(); loadStats(); } else alert('Update failed');
}

// ========== SUBSCRIBERS ==========
async function loadSubscribers() {
  const c = document.getElementById('subTable');
  c.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
  try {
    const interest = document.getElementById('subFilter')?.value || '';
    let url = '/api/admin/contacts?type=subscribe&limit=50';
    const data = await af(url);
    let list = data.contacts || [];
    if (interest) list = list.filter(s => s.interest === interest);
    if (!list.length) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¨</div><h3>No subscribers found</h3></div>'; return; }
    let h = '<table class="data-table"><thead><tr><th>Subscriber</th><th>Hearing Status</th><th>Interest</th><th>Subscribed</th></tr></thead><tbody>';
    list.forEach(s => {
      const name = s.firstName || s.email.split('@')[0];
      h += '<tr><td><div class="user-name-cell"><div class="user-avatar subscriber">'+(name[0]||'?').toUpperCase()+'</div><div class="user-detail"><strong>'+name+'</strong><small>'+s.email+'</small></div></div></td>'+
        '<td>'+(s.hearingStatus||'-')+'</td>'+
        '<td>'+(s.interest||'general')+'</td>'+
        '<td>'+fmtDate(s.submittedAt)+'</td></tr>';
    });
    h += '</tbody></table>';
    c.innerHTML = h;
  } catch(e) { c.innerHTML = '<div class="empty-state"><p>'+e.message+'</p></div>'; }
}
</script>
</body>
</html>
